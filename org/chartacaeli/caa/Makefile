ifeq ($(OS),Windows_NT)
	winos := 1
else
	linos := 1
endif

# AA+ V2.50
DST = aaplus
JNI = caa

PKG = org.chartacaeli.$(JNI)

# top-level directory is current minus package (e.g. /foo/bar/hot minus bar.hot yields /foo)
topdir = $(subst $(subst .,/,$(PKG)),,$(CURDIR))
srcdir = src

AAZIP = $(DST).zip
AAURL = http://www.naughter.com/download/$(AAZIP)
ifdef winos
AADLL = $(DST).dll
AAEXE = AATest.exe

CAADLL = $(JNI).dll
else
AADLL = lib$(DST).so
AAEXE = AATest

CAADLL = lib$(JNI).so
endif

.PHONY: hdr jni clean lclean rclean tidy
.SUFFIXES: .cache .cxx .dll .so

vpath %.cpp $(srcdir)

# C++ source files in $(AAZIP)
AADLLSRC = \
	$(srcdir)/AAAberration.cpp \
	$(srcdir)/AAAngularSeparation.cpp \
	$(srcdir)/AABinaryStar.cpp \
	$(srcdir)/AACoordinateTransformation.cpp \
	$(srcdir)/AADate.cpp \
	$(srcdir)/AADiameters.cpp \
	$(srcdir)/AADynamicalTime.cpp \
	$(srcdir)/AAELP2000.cpp \
	$(srcdir)/AAELPMPP02.cpp \
	$(srcdir)/AAEarth.cpp \
	$(srcdir)/AAEclipses.cpp \
	$(srcdir)/AAEclipticalElements.cpp \
	$(srcdir)/AAElementsPlanetaryOrbit.cpp \
	$(srcdir)/AAElliptical.cpp \
	$(srcdir)/AAEquationOfTime.cpp \
	$(srcdir)/AAEquinoxesAndSolstices.cpp \
	$(srcdir)/AAEquinoxesAndSolstices2.cpp \
	$(srcdir)/AAFK5.cpp \
	$(srcdir)/AAGalileanMoons.cpp \
	$(srcdir)/AAGlobe.cpp \
	$(srcdir)/AAIlluminatedFraction.cpp \
	$(srcdir)/AAInterpolate.cpp \
	$(srcdir)/AAJewishCalendar.cpp \
	$(srcdir)/AAJupiter.cpp \
	$(srcdir)/AAKepler.cpp \
	$(srcdir)/AAMars.cpp \
	$(srcdir)/AAMercury.cpp \
	$(srcdir)/AAMoon.cpp \
	$(srcdir)/AAMoonIlluminatedFraction.cpp \
	$(srcdir)/AAMoonMaxDeclinations.cpp \
	$(srcdir)/AAMoonMaxDeclinations2.cpp \
	$(srcdir)/AAMoonNodes.cpp \
	$(srcdir)/AAMoonNodes2.cpp \
	$(srcdir)/AAMoonPerigeeApogee.cpp \
	$(srcdir)/AAMoonPerigeeApogee2.cpp \
	$(srcdir)/AAMoonPhases.cpp \
	$(srcdir)/AAMoonPhases2.cpp \
	$(srcdir)/AAMoslemCalendar.cpp \
	$(srcdir)/AANearParabolic.cpp \
	$(srcdir)/AANeptune.cpp \
	$(srcdir)/AANodes.cpp \
	$(srcdir)/AANutation.cpp \
	$(srcdir)/AAParabolic.cpp \
	$(srcdir)/AAParallactic.cpp \
	$(srcdir)/AAParallax.cpp \
	$(srcdir)/AAPhysicalJupiter.cpp \
	$(srcdir)/AAPhysicalMars.cpp \
	$(srcdir)/AAPhysicalMoon.cpp \
	$(srcdir)/AAPhysicalSun.cpp \
	$(srcdir)/AAPlanetPerihelionAphelion.cpp \
	$(srcdir)/AAPlanetPerihelionAphelion2.cpp \
	$(srcdir)/AAPlanetaryPhenomena.cpp \
	$(srcdir)/AAPlanetaryPhenomena2.cpp \
	$(srcdir)/AAPluto.cpp \
	$(srcdir)/AAPrecession.cpp \
	$(srcdir)/AARefraction.cpp \
	$(srcdir)/AARiseTransitSet.cpp \
	$(srcdir)/AARiseTransitSet2.cpp \
	$(srcdir)/AASaturn.cpp \
	$(srcdir)/AASaturnMoons.cpp \
	$(srcdir)/AASaturnRings.cpp \
	$(srcdir)/AASidereal.cpp \
	$(srcdir)/AAStellarMagnitudes.cpp \
	$(srcdir)/AASun.cpp \
	$(srcdir)/AAUranus.cpp \
	$(srcdir)/AAVSOP87.cpp \
	$(srcdir)/AAVSOP87A_EAR.cpp \
	$(srcdir)/AAVSOP87A_EMB.cpp \
	$(srcdir)/AAVSOP87A_JUP.cpp \
	$(srcdir)/AAVSOP87A_MAR.cpp \
	$(srcdir)/AAVSOP87A_MER.cpp \
	$(srcdir)/AAVSOP87A_NEP.cpp \
	$(srcdir)/AAVSOP87A_SAT.cpp \
	$(srcdir)/AAVSOP87A_URA.cpp \
	$(srcdir)/AAVSOP87A_VEN.cpp \
	$(srcdir)/AAVSOP87B_EAR.cpp \
	$(srcdir)/AAVSOP87B_JUP.cpp \
	$(srcdir)/AAVSOP87B_MAR.cpp \
	$(srcdir)/AAVSOP87B_MER.cpp \
	$(srcdir)/AAVSOP87B_NEP.cpp \
	$(srcdir)/AAVSOP87B_SAT.cpp \
	$(srcdir)/AAVSOP87B_URA.cpp \
	$(srcdir)/AAVSOP87B_VEN.cpp \
	$(srcdir)/AAVSOP87C_EAR.cpp \
	$(srcdir)/AAVSOP87C_JUP.cpp \
	$(srcdir)/AAVSOP87C_MAR.cpp \
	$(srcdir)/AAVSOP87C_MER.cpp \
	$(srcdir)/AAVSOP87C_NEP.cpp \
	$(srcdir)/AAVSOP87C_SAT.cpp \
	$(srcdir)/AAVSOP87C_URA.cpp \
	$(srcdir)/AAVSOP87C_VEN.cpp \
	$(srcdir)/AAVSOP87D_EAR.cpp \
	$(srcdir)/AAVSOP87D_JUP.cpp \
	$(srcdir)/AAVSOP87D_MAR.cpp \
	$(srcdir)/AAVSOP87D_MER.cpp \
	$(srcdir)/AAVSOP87D_NEP.cpp \
	$(srcdir)/AAVSOP87D_SAT.cpp \
	$(srcdir)/AAVSOP87D_URA.cpp \
	$(srcdir)/AAVSOP87D_VEN.cpp \
	$(srcdir)/AAVSOP87E_EAR.cpp \
	$(srcdir)/AAVSOP87E_JUP.cpp \
	$(srcdir)/AAVSOP87E_MAR.cpp \
	$(srcdir)/AAVSOP87E_MER.cpp \
	$(srcdir)/AAVSOP87E_NEP.cpp \
	$(srcdir)/AAVSOP87E_SAT.cpp \
	$(srcdir)/AAVSOP87E_SUN.cpp \
	$(srcdir)/AAVSOP87E_URA.cpp \
	$(srcdir)/AAVSOP87E_VEN.cpp \
	$(srcdir)/AAVSOP87_EMB.cpp \
	$(srcdir)/AAVSOP87_JUP.cpp \
	$(srcdir)/AAVSOP87_MAR.cpp \
	$(srcdir)/AAVSOP87_MER.cpp \
	$(srcdir)/AAVSOP87_NEP.cpp \
	$(srcdir)/AAVSOP87_SAT.cpp \
	$(srcdir)/AAVSOP87_URA.cpp \
	$(srcdir)/AAVSOP87_VEN.cpp \
	$(srcdir)/AAVenus.cpp \

AADLLOBJ = $(patsubst $(srcdir)/%.cpp,%.o,$(AADLLSRC))

# JNI code generated by CXXWRAP
CAADLLSRC = \
	CAA2DCoordinate_jni.cxx \
	CAA3DCoordinate_jni.cxx \
	CAAAberration_jni.cxx \
	CAAAngularSeparation_jni.cxx \
	CAABinaryStarDetails_jni.cxx \
	CAABinaryStar_jni.cxx \
	CAACalendarDate_jni.cxx \
	CAACoordinateTransformation_jni.cxx \
	CAADate_jni.cxx \
	CAADiameters_jni.cxx \
	CAADynamicalTime_jni.cxx \
	CAAELP2000_jni.cxx \
	CAAELPMPP02_jni.cxx \
	CAAEarth_jni.cxx \
	CAAEasterDetails_jni.cxx \
	CAAEaster_jni.cxx \
	CAAEclipses_jni.cxx \
	CAAEclipticalElementDetails_jni.cxx \
	CAAEclipticalElements_jni.cxx \
	CAAElementsPlanetaryOrbit_jni.cxx \
	CAAEllipticalObjectDetails_jni.cxx \
	CAAEllipticalObjectElements_jni.cxx \
	CAAEllipticalPlanetaryDetails_jni.cxx \
	CAAElliptical_jni.cxx \
	CAAEquationOfTime_jni.cxx \
	CAAEquinoxSolsticeDetails2_jni.cxx \
	CAAEquinoxesAndSolstices2_jni.cxx \
	CAAEquinoxesAndSolstices_jni.cxx \
	CAAFK5_jni.cxx \
	CAAGalileanMoonDetail_jni.cxx \
	CAAGalileanMoonsDetails_jni.cxx \
	CAAGalileanMoons_jni.cxx \
	CAAGlobe_jni.cxx \
	CAAIlluminatedFraction_jni.cxx \
	CAAInterpolate_jni.cxx \
	CAAJewishCalendar_jni.cxx \
	CAAJupiter_jni.cxx \
	CAAKepler_jni.cxx \
	CAALunarEclipseDetails_jni.cxx \
	CAAMars_jni.cxx \
	CAAMercury_jni.cxx \
	CAAMoonIlluminatedFraction_jni.cxx \
	CAAMoonMaxDeclinationsDetails2_jni.cxx \
	CAAMoonMaxDeclinations_jni.cxx \
	CAAMoonNodesDetails2_jni.cxx \
	CAAMoonNodes_jni.cxx \
	CAAMoonPerigeeApogeeDetails2_jni.cxx \
	CAAMoonPerigeeApogee_jni.cxx \
	CAAMoonPhasesDetails2_jni.cxx \
	CAAMoonPhases_jni.cxx \
	CAAMoon_jni.cxx \
	CAAMoslemCalendar_jni.cxx \
	CAANearParabolicObjectDetails_jni.cxx \
	CAANearParabolicObjectElements_jni.cxx \
	CAANearParabolic_jni.cxx \
	CAANeptune_jni.cxx \
	CAANodeObjectDetails_jni.cxx \
	CAANodes_jni.cxx \
	CAANutation_jni.cxx \
	CAAParabolicObjectDetails_jni.cxx \
	CAAParabolicObjectElements_jni.cxx \
	CAAParabolic_jni.cxx \
	CAAParallactic_jni.cxx \
	CAAParallax_jni.cxx \
	CAAPhysicalJupiterDetails_jni.cxx \
	CAAPhysicalJupiter_jni.cxx \
	CAAPhysicalMarsDetails_jni.cxx \
	CAAPhysicalMars_jni.cxx \
	CAAPhysicalMoonDetails_jni.cxx \
	CAAPhysicalMoon_jni.cxx \
	CAAPhysicalSunDetails_jni.cxx \
	CAAPhysicalSun_jni.cxx \
	CAAPlanetPerihelionAphelion2_jni.cxx \
	CAAPlanetPerihelionAphelionDetails2_jni.cxx \
	CAAPlanetPerihelionAphelion_jni.cxx \
	CAAPlanetaryPhenomena2_jni.cxx \
	CAAPlanetaryPhenomenaDetails2_jni.cxx \
	CAAPlanetaryPhenomena_jni.cxx \
	CAAPluto_jni.cxx \
	CAAPrecession_jni.cxx \
	CAARefraction_jni.cxx \
	CAARiseTransitSetDetails2_jni.cxx \
	CAARiseTransitSetDetails_jni.cxx \
	CAARiseTransitSet_jni.cxx \
	CAASaturnMoonDetail_jni.cxx \
	CAASaturnMoonsDetails_jni.cxx \
	CAASaturnMoons_jni.cxx \
	CAASaturnRingDetails_jni.cxx \
	CAASaturnRings_jni.cxx \
	CAASaturn_jni.cxx \
	CAASelenographicMoonDetails_jni.cxx \
	CAASidereal_jni.cxx \
	CAASolarEclipseDetails_jni.cxx \
	CAAStellarMagnitudes_jni.cxx \
	CAASun_jni.cxx \
	CAATopocentricEclipticDetails_jni.cxx \
	CAAUranus_jni.cxx \
	CAAVSOP87A_EMB_jni.cxx \
	CAAVSOP87A_Earth_jni.cxx \
	CAAVSOP87A_Jupiter_jni.cxx \
	CAAVSOP87A_Mars_jni.cxx \
	CAAVSOP87A_Mercury_jni.cxx \
	CAAVSOP87A_Neptune_jni.cxx \
	CAAVSOP87A_Saturn_jni.cxx \
	CAAVSOP87A_Uranus_jni.cxx \
	CAAVSOP87A_Venus_jni.cxx \
	CAAVSOP87B_Earth_jni.cxx \
	CAAVSOP87B_Jupiter_jni.cxx \
	CAAVSOP87B_Mars_jni.cxx \
	CAAVSOP87B_Mercury_jni.cxx \
	CAAVSOP87B_Neptune_jni.cxx \
	CAAVSOP87B_Saturn_jni.cxx \
	CAAVSOP87B_Uranus_jni.cxx \
	CAAVSOP87B_Venus_jni.cxx \
	CAAVSOP87C_Earth_jni.cxx \
	CAAVSOP87C_Jupiter_jni.cxx \
	CAAVSOP87C_Mars_jni.cxx \
	CAAVSOP87C_Mercury_jni.cxx \
	CAAVSOP87C_Neptune_jni.cxx \
	CAAVSOP87C_Saturn_jni.cxx \
	CAAVSOP87C_Uranus_jni.cxx \
	CAAVSOP87C_Venus_jni.cxx \
	CAAVSOP87D_Earth_jni.cxx \
	CAAVSOP87D_Jupiter_jni.cxx \
	CAAVSOP87D_Mars_jni.cxx \
	CAAVSOP87D_Mercury_jni.cxx \
	CAAVSOP87D_Neptune_jni.cxx \
	CAAVSOP87D_Saturn_jni.cxx \
	CAAVSOP87D_Uranus_jni.cxx \
	CAAVSOP87D_Venus_jni.cxx \
	CAAVSOP87E_Earth_jni.cxx \
	CAAVSOP87E_Jupiter_jni.cxx \
	CAAVSOP87E_Mars_jni.cxx \
	CAAVSOP87E_Mercury_jni.cxx \
	CAAVSOP87E_Neptune_jni.cxx \
	CAAVSOP87E_Saturn_jni.cxx \
	CAAVSOP87E_Sun_jni.cxx \
	CAAVSOP87E_Uranus_jni.cxx \
	CAAVSOP87E_Venus_jni.cxx \
	CAAVSOP87_EMB_jni.cxx \
	CAAVSOP87_Jupiter_jni.cxx \
	CAAVSOP87_Mars_jni.cxx \
	CAAVSOP87_Mercury_jni.cxx \
	CAAVSOP87_Neptune_jni.cxx \
	CAAVSOP87_Saturn_jni.cxx \
	CAAVSOP87_Uranus_jni.cxx \
	CAAVSOP87_Venus_jni.cxx \
	CAAVSOP87_jni.cxx \
	CAAVenus_jni.cxx \
	VSOP87Coefficient2_jni.cxx \
	VSOP87Coefficient_jni.cxx \

CAADLLOBJ = $(patsubst %.cxx,%.o,$(CAADLLSRC))

CXXWRAP_CACHE = \
	AA2DCoordinate.cache \
	AA3DCoordinate.cache \
	AADate.cache \
	AAElliptical.cache \
	AAParabolic.cache \

.h.cache:
	cxxwrap --verbose \
		--write-cache=$@ \
		--jni --jni-attributes \
		--classpath=$(topdir) \
		--package-prefix=$(PKG) $<

.cpp.o:
	$(CXX) -std=c++17 -Wall -fPIC -c $< -o $@

ifdef winos
.cxx.o:
	$(CXX) -std=c++17 -Wall -fPIC \
		-I"$(JAVA_HOME)/include" \
		-I"$(JAVA_HOME)/include/win32" \
		-I. -I$(srcdir) \
		-c $< -o $@
else
.cxx.o:
	$(CXX) -std=c++17 -Wall -fPIC \
		-I$(JAVA_HOME)/include \
		-I$(JAVA_HOME)/include/linux \
		-I. -I$(srcdir) \
		-c $< -o $@
endif

$(CAADLL): $(AADLL) $(CAADLLOBJ)
	$(CXX) -Wall -shared -fPIC \
		-o $@ $(CAADLLOBJ) \
		-L. -l$(DST)

$(AADLL): $(AADLLOBJ)
	$(CXX) -Wall -shared -fPIC \
		-o $@ $^

$(AADLLOBJ): | $(srcdir)

$(srcdir): $(AAZIP)
	unzip -o `basename $(AAURL)` -d $@

$(AAZIP):
	wget -q -O $@ $(AAURL)

$(AAEXE): AATest.o $(AADLL)
	$(CXX) -o $@ $< -L. -l$(DST)

AATest.o: AATest.cpp
	$(CXX) \
		-DAAPLUS_ELP2000_NO_HIGH_PRECISION \
		-DAAPLUS_NO_ELPMPP02 \
		-std=c++17 -Wall -c $< -o $@

hdr: $(srcdir)
	# 1. remove CR from CRLF line endings
	# 2. remove leading whitespace from preprocessor directives
	for h in src/AA[!+]*.h ; do \
		sed \
			-e 's,\r,,' \
			-e 's,^[ ][ ]*\#,\#,' \
			$$h >$$(basename $$h) ; \
	done

jni: $(CXXWRAP_CACHE)
	( for c in $^ ; do \
		cxxwrap_cache="$$cxxwrap_cache --read-cache=$$c" ; \
	done ; \
	for h in *.h ; do \
		cxxwrap --verbose \
			$$cxxwrap_cache \
			--jni --jni-attributes \
			--classpath=$(topdir) \
			--package-prefix=$(PKG) $$h ; \
	done )

test: $(AAEXE)
	./$<

# compiler objects
clean:
	rm -f *.o *.class

# local clean
lclean: clean
	rm -rf $(srcdir)
	rm -f *.cxx *.java *.h *.cache
	rm -f $(AADLL) $(CAADLL) $(AAEXE)

# real clean
rclean: lclean
	rm -rf $(AAZIP)

tidy: rclean
